id: 530a848f-3351-470e-83ac-4768a8a291cb
name: DET-015 - Endpoint - XDR - Severe Host Malware Activity
version: 1.0.1
kind: Scheduled
description: >
  Creates an incident for high-severity malware alerts raised by Microsoft Defender
  for Endpoint (MDE). One incident per vendor alert, with vendor link and identifiers.
severity: High
enabled: true
query: |
  let lookback = 10m;
  SecurityAlert
  | where TimeGenerated between (ago(lookback) .. now())
  | where isnotempty(SystemAlertId)
  // Target MDE alerts only, and avoid any Sentinel-generated noise
  | where (ProviderName in~ ("MDATP","Microsoft Defender for Endpoint")
          or ProductName has "Defender for Endpoint")
        and ProductName !contains "Sentinel"
        and ProviderName !contains "Sentinel"
  // Severe malware/harmful families (keep High, also catch strong malware/ransom naming)
  | where AlertSeverity =~ "High"
        or AlertName has "malware"
        or AlertName has "ransom"
  // De-duplicate in case a vendor alert is updated within the window
  | summarize arg_max(TimeGenerated, *) by tostring(SystemAlertId)
  | project
      TimeGenerated,
      ProviderName,
      ProductName,
      AlertName,
      AlertSeverity,
      CompromisedEntity,
      SystemAlertId,
      AlertLink,
      Entities
queryFrequency: PT5M
queryPeriod: PT10M
triggerOperator: GreaterThan
triggerThreshold: 0
tactics:
  - Execution
  - Persistence
  - DefenseEvasion
relevantTechniques:
  - T1204
  - T1053
  - T1562
# Suppress re-alerts when the same SystemAlertId falls into consecutive runs
suppressionEnabled: true
suppressionDuration: PT10M
eventGroupingSettings:
  aggregationKind: AlertPerResult
alertDetailsOverride:
  alertDisplayNameFormat: 'MDE Severe Malware Alert on {{CompromisedEntity}}: {{AlertName}}'
  alertDescriptionFormat: >
    High-severity malware activity observed by {{ProductName}} ({{ProviderName}}).
    Vendor link: {{AlertLink}} | SystemAlertId: {{SystemAlertId}}
customDetails:
  SystemAlertId: '{{SystemAlertId}}'
  ProviderName: '{{ProviderName}}'
  ProductName: '{{ProductName}}'
  AlertLink: '{{AlertLink}}'
  Host: '{{CompromisedEntity}}'
entityMappings:
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: CompromisedEntity
incidentConfiguration:
  createIncident: true
  groupingConfiguration:
    enabled: false
