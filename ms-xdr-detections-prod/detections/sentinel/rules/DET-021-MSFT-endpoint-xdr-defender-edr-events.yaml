id: 6cbbdeb9-3433-4435-8a40-3208d7529bc3
name: DET-021 - Endpoint - XDR - Defender - EDR Events - Rule
version: 1.0.1
kind: Scheduled
description: >
  Creates an incident for Microsoft Defender for Endpoint (MDE) SecurityAlert events
  (Medium severity rule). One incident per vendor alert, deduped by SystemAlertId.
severity: Medium
enabled: true
query: |
  let lookback = 10m;
  SecurityAlert
  | where TimeGenerated between (ago(lookback) .. now())
  | where isnotempty(SystemAlertId)
  // Focus on MDE alerts only; avoid Sentinel-generated noise
  | where (ProviderName in~ ("MDATP","Microsoft Defender for Endpoint")
          or ProductName has "Defender for Endpoint")
        and ProductName !contains "Sentinel"
        and ProviderName !contains "Sentinel"
  // Trim low-value chatter for this feed
  | where AlertSeverity !~ "Informational"
  // De-duplicate if the vendor alert updates within the window
  | summarize arg_max(TimeGenerated, *) by tostring(SystemAlertId)
  | project
      TimeGenerated,
      ProviderName,
      ProductName,
      AlertName,
      AlertSeverity,
      CompromisedEntity,
      SystemAlertId,
      AlertLink,
      Entities
queryFrequency: PT5M
queryPeriod: PT10M
triggerOperator: GreaterThan
triggerThreshold: 0
tactics:
  - Execution
  - Discovery
relevantTechniques:
  - T1059
  - T1082
# Prevent re-alerts when the same vendor alert remains in subsequent runs
suppressionEnabled: true
suppressionDuration: PT10M
eventGroupingSettings:
  aggregationKind: AlertPerResult
alertDetailsOverride:
  alertDisplayNameFormat: 'MDE EDR Alert on {{CompromisedEntity}}: {{AlertName}} ({{AlertSeverity}})'
  alertDescriptionFormat: >
    Microsoft Defender for Endpoint alert ({{ProviderName}} / {{ProductName}}).
    Vendor link: {{AlertLink}} | SystemAlertId: {{SystemAlertId}}
customDetails:
  SystemAlertId: '{{SystemAlertId}}'
  ProviderName: '{{ProviderName}}'
  ProductName: '{{ProductName}}'
  AlertLink: '{{AlertLink}}'
  Host: '{{CompromisedEntity}}'
entityMappings:
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: CompromisedEntity
incidentConfiguration:
  createIncident: true
  groupingConfiguration:
    enabled: false
