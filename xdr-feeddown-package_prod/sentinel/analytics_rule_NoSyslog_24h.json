{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspaceResourceId": {
      "type": "string"
    },
    "ruleDisplayName": {
      "type": "string",
      "defaultValue": "Network Device not logging in 24h"
    },
    "ruleId": {
      "type": "string",
      "defaultValue": "00000000-0000-0000-0000-000000000024"
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "apiVersion": "2023-02-01-preview",
      "name": "[concat(split(parameters('workspaceResourceId'), '/')[8], '/Microsoft.SecurityInsights/', parameters('ruleId'))]",
      "properties": {
        "displayName": "[parameters('ruleDisplayName')]",
        "description": "Auto-generated by CIRT Handoff package.",
        "enabled": true,
        "severity": "High",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT25H",
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "kind": "Scheduled",
        "eventGroupingSettings": {
          "aggregationKind": "SingleAlert"
        },
        "suppressionEnabled": false,
        "suppressionDuration": "PT0H",
        "alertDetailsOverride": {
          "alertDisplayNameFormat": "Device {{DeviceName}} not logging in 24h",
          "alertDescriptionFormat": "DeviceType={{DeviceType}} | Site={{Site}} | LastSeen={{LastSeen}}"
        },
        "entityMappings": [
          {
            "entityType": "Host",
            "fieldMappings": [
              {
                "identifier": "HostName",
                "columnName": "DeviceName"
              }
            ]
          },
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "IP"
              }
            ]
          }
        ],
        "query": "[concat(base64ToString('Ci8vIFNUUklDVCBwZXItZGV2aWNlIG1pc3NpbmcgbG9ncyAoMjRoKSwgbWFwcGluZzogU3lzbG9nLkNvbXB1dGVyID09IFdhdGNobGlzdFsnU2VudGluZWwgTG9va3VwJ10KbGV0IHdhdGNobGlzdE5hbWUgPSAnTmV0d29ya0RldmljZXNfV2F0Y2hsaXN0JzsKbGV0IGxvb2tiYWNrID0gMjVoOyAgICAvLyAyNGggKyBqaXR0ZXIgYnVmZmVyCmxldCB0aHJlc2hvbGQgPSAyNGg7CmxldCBub3dVdGMgPSBub3coKTsKLy8gV2F0Y2hsaXN0IGxvYWQgJiBub3JtYWxpemF0aW9uCmxldCBXTCA9IF9HZXRXYXRjaGxpc3Qod2F0Y2hsaXN0TmFtZSkKfCBwcm9qZWN0IERldmljZU5hbWVSYXcgPSB0b3N0cmluZyhbJ1NlbnRpbmVsIExvb2t1cCddKSwKICAgICAgICAgIElQID0gdG9zdHJpbmcoWydJUCBBZGRyZXNzJ10pLAogICAgICAgICAgRGV2aWNlVHlwZSA9IHRvc3RyaW5nKFsnZGV2aWNlIHR5cGUnXSksCiAgICAgICAgICBTaXRlID0gdG9zdHJpbmcoWydzaXRlJ10pLAogICAgICAgICAgRW5hYmxlZFJhdyA9IHRvc3RyaW5nKFsnZW5hYmxlZCddKSwKICAgICAgICAgIFN1cHByZXNzVW50aWwgPSB0b2RhdGV0aW1lKFsnc3VwcHJlc3NfdW50aWwnXSksCiAgICAgICAgICBPd25lciA9IHRvc3RyaW5nKFsnb3duZXInXSksCiAgICAgICAgICBOb3RlcyA9IHRvc3RyaW5nKFsnbm90ZXMnXSkKfCBleHRlbmQgRGV2aWNlS2V5ID0gdG9sb3dlcih0cmltKCcgJywgRGV2aWNlTmFtZVJhdykpLAogICAgICAgICBFbmFibGVkID0gY2FzZSh0b3VwcGVyKEVuYWJsZWRSYXcpIGluICgnRkFMU0UnLCcwJywnTk8nLCdOJywnRElTQUJMRUQnKSwgZmFsc2UsIHRydWUpCnwgd2hlcmUgRW5hYmxlZCA9PSB0cnVlCnwgd2hlcmUgaXNudWxsKFN1cHByZXNzVW50aWwpIG9yIFN1cHByZXNzVW50aWwgPCBub3dVdGMKfCBleHRlbmQgU2l0ZSA9IGlpZihpc2VtcHR5KFNpdGUpLCB0b3N0cmluZyhzcGxpdChEZXZpY2VLZXksICctJylbMF0pLCBTaXRlKTsKLy8gU3VtbWFyaXplIGxhc3Qgc2VlbiBmcm9tIFN5c2xvZwpsZXQgQWN0aXZlID0gU3lzbG9nCnwgd2hlcmUgVGltZUdlbmVyYXRlZCA+IG5vd1V0YyAtIGxvb2tiYWNrCnwgZXh0ZW5kIENvbXB1dGVyS2V5ID0gdG9sb3dlcih0cmltKCcgJywgdG9zdHJpbmcoQ29tcHV0ZXIpKSkKfCBzdW1tYXJpemUgTGFzdFNlZW4gPSBtYXgoVGltZUdlbmVyYXRlZCksCiAgICAgICAgICAgIFNhbXBsZUhvc3RJUCA9IGFueShIb3N0SVApIGJ5IENvbXB1dGVyS2V5OwovLyBTdHJpY3QgZXF1YWxpdHkgam9pbgpXTAp8IGpvaW4ga2luZD1sZWZ0b3V0ZXIgQWN0aXZlIG9uICRsZWZ0LkRldmljZUtleSA9PSAkcmlnaHQuQ29tcHV0ZXJLZXkKfCBleHRlbmQgTGFzdFNlZW5Db21iaW5lZCA9IExhc3RTZWVuCnwgZXh0ZW5kIE1pc3NpbmcgPSBpaWYoaXNudWxsKExhc3RTZWVuQ29tYmluZWQpIG9yIExhc3RTZWVuQ29tYmluZWQgPCBub3dVdGMgLSB0aHJlc2hvbGQsIDEsIDApCnwgZXh0ZW5kIFJlYXNvbiA9IGNhc2UoaXNudWxsKExhc3RTZWVuQ29tYmluZWQpLCAnTm8gU3lzbG9nIHNlZW4gaW4gbG9va2JhY2sgd2luZG93JywKICAgICAgICAgICAgICAgICAgICAgICBzdHJjYXQoJ0xhc3Qgc2VlbiBhdCAnLCBmb3JtYXRfZGF0ZXRpbWUoTGFzdFNlZW5Db21iaW5lZCwgJ3l5eXktTU0tZGQgSEg6bW06c3MnKSwgJ1onKSkKfCBwcm9qZWN0IERldmljZU5hbWUgPSBEZXZpY2VOYW1lUmF3LCBJUCwgRGV2aWNlVHlwZSwgU2l0ZSwgT3duZXIsIE5vdGVzLCBMYXN0U2VlbiA9IExhc3RTZWVuQ29tYmluZWQsIE1pc3NpbmcsIFJlYXNvbiwgSG9zdElQID0gU2FtcGxlSG9zdElQCnwgd2hlcmUgTWlzc2luZyA9PSAxCg=='))]"
      }
    }
  ]
}